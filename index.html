<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Recommender Demo (v2.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* √Åp d·ª•ng font Inter l√†m font ch·ªØ m·∫∑c ƒë·ªãnh */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        
        /* T√πy ch·ªânh thanh cu·ªôn cho chatbot */
        #chat-history {
            scroll-behavior: smooth;
        }
        #chat-history::-webkit-scrollbar {
            width: 6px;
        }
        #chat-history::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #chat-history::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        #chat-history::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* ·∫®n thanh cu·ªôn m·∫∑c ƒë·ªãnh c·ªßa tr√¨nh duy·ªát n·∫øu c·∫ßn */
        html {
            overflow-y: auto; /* Gi·ªØ thanh cu·ªôn ch√≠nh */
        }
        
        /* Hi·ªáu ·ª©ng loading cho chatbot */
        .loader {
            width: 16px;
            height: 16px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 4px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* === PH·∫¶N S·ª¨A L·ªñI === */
        
        /* Style cho n√∫t l·ªçc s·∫£n ph·∫©m (CSS ti√™u chu·∫©n) */
        .filter-btn {
            padding-left: 1rem; /* px-4 */
            padding-right: 1rem; /* px-4 */
            padding-top: 0.5rem; /* py-2 */
            padding-bottom: 0.5rem; /* py-2 */
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 500; /* font-medium */
            font-size: 0.875rem; /* text-sm */
            transition-property: color, background-color; /* transition-colors */
            transition-duration: 200ms; /* duration-200 */
        }
        
        .filter-btn.active {
            background-color: #2563eb; /* bg-blue-600 */
            color: #ffffff; /* text-white */
        }
        
        .filter-btn:not(.active) {
            background-color: #ffffff; /* bg-white */
            color: #374151; /* text-gray-700 */
        }
        
        .filter-btn:not(.active):hover {
            background-color: #f3f4f6; /* hover:bg-gray-100 */
        }
        
        /* Th√™m style cho n√∫t Like/Dislike (CSS ti√™u chu·∫©n) */
        .feedback-btn {
            padding-left: 0.5rem; /* px-2 */
            padding-right: 0.5rem; /* px-2 */
            padding-top: 0.25rem; /* py-1 */
            padding-bottom: 0.25rem; /* py-1 */
            border-radius: 9999px; /* rounded-full */
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
            transition-property: color, background-color;
            transition-duration: 200ms;
        }
        
        .like-btn {
            background-color: #dcfce7; /* bg-green-100 */
            color: #166534; /* text-green-700 */
        }
        .like-btn:hover {
            background-color: #bbf7d0; /* hover:bg-green-200 */
        }
        
        .dislike-btn {
            background-color: #fee2e2; /* bg-red-100 */
            color: #991b1b; /* text-red-700 */
        }
        .dislike-btn:hover {
            background-color: #fecaca; /* hover:bg-red-200 */
        }
        
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <div class="container mx-auto max-w-7xl p-4 lg:p-8">
        <h1 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-6">G·ª£i √ù Thi·∫øt B·ªã Gia D·ª•ng Th√¥ng Minh (v2.0)</h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">

            <div class="lg:col-span-2 space-y-8">
                
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <label for="user-select" class="block text-sm font-medium text-gray-700 mb-2">Ch·ªçn ng∆∞·ªùi d√πng:</label>
                    <select id="user-select" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                        </select>
                </div>

                <div>
                    <h2 class="text-2xl font-semibold mb-4" id="recommendation-title">G·ª£i √Ω cho b·∫°n</h2>
                    <div id="recommendation-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                </div>

                <div>
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                        <h2 class="text-2xl font-semibold">T·∫•t c·∫£ s·∫£n ph·∫©m</h2>
                        <div id="filter-toolbar" class="flex flex-wrap gap-2 mt-4 md:mt-0">
                            </div>
                    </div>
                    <div id="all-products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                </div>

            </div>

            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-md lg:sticky lg:top-8" style="height: calc(100vh - 4rem);">
                    <div class="flex flex-col h-full">
                        <div class="p-4 border-b border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-800">ü§ñ AI Chatbot T∆∞ V·∫•n</h2>
                            <p id="chatbot-subtitle" class="text-sm text-gray-500">H·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨!</p>
                        </div>

                        <div id="chat-history" class="flex-1 p-4 space-y-4 overflow-y-auto">
                            <div class="flex">
                                <span class="flex-shrink-0 bg-blue-500 text-white text-sm font-semibold rounded-full h-8 w-8 items-center justify-center flex mr-3">AI</span>
                                <div class="bg-blue-100 text-gray-800 p-3 rounded-lg max-w-xs">
                                    <p>Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p b·∫°n ch·ªçn thi·∫øt b·ªã gia d·ª•ng th√¥ng minh n√†o h√¥m nay?</p>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-xl">
                            <div class="flex items-center space-x-2">
                                <input type="text" id="chat-input" class="flex-1 border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" placeholder="Nh·∫≠p tin nh·∫Øn...">
                                <button id="send-button" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                                    G·ª≠i
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- 1. DATA LAYER (Gi·∫£ l·∫≠p d·ªØ li·ªáu) ---

        const users = [
            { id: 1, name: "An (Y√™u c√¥ng ngh·ªá)", age: 28, budget: "high", interest: "entertainment", home_size: "medium" },
            { id: 2, name: "B√¨nh (N·ªôi tr·ª£)", age: 45, budget: "medium", interest: "kitchen", home_size: "large" },
            { id: 3, name: "Chi (Ti·∫øt ki·ªám)", age: 35, budget: "low", interest: "utility", home_size: "small" },
            { id: 4, name: "D≈©ng (Game th·ªß)", age: 22, budget: "medium", interest: "entertainment", home_size: "small" }
        ];

        const products = [
            // C·∫¨P NH·∫¨T: Th√™m tr∆∞·ªùng `imageUrl` ƒë·ªÉ d·ªÖ d√†ng thay ƒë·ªïi ·∫£nh
            { id: 101, name: "TV OLED 8K 65-inch", brand: "LG", category: "entertainment", price: 2500, price_range: "high", features: ["AI", "8K", "WebOS"], description: "TV th√¥ng minh 8K v·ªõi AI n√¢ng c·∫•p h√¨nh ·∫£nh.", imageUrl: "image/tv_oled_8k.jpg" },
            { id: 102, name: "T·ªß l·∫°nh Smart InstaView", brand: "Samsung", category: "kitchen", price: 1800, price_range: "high", features: ["Inverter", "L·∫•y ƒë√° ngo√†i", "M√†n h√¨nh"], description: "T·ªß l·∫°nh side-by-side v·ªõi m√†n h√¨nh c·∫£m ·ª©ng.", imageUrl: "image/tu_lanh.jpg" },
            { id: 103, name: "Robot h√∫t b·ª•i Roomba X", brand: "iRobot", category: "utility", price: 800, price_range: "medium", features: ["AI", "T·ª± s·∫°c", "Lau nh√†"], description: "Robot t·ª± ƒë·ªông l·∫≠p b·∫£n ƒë·ªì nh√† v√† lau d·ªçn.", imageUrl: "image/robot.jpg" },
            { id: 104, name: "N·ªìi chi√™n kh√¥ng d·∫ßu Smart", brand: "Philips", category: "kitchen", price: 300, price_range: "medium", features: ["App control", "H·∫πn gi·ªù"], description: "ƒêi·ªÅu khi·ªÉn qua app, n·∫•u ƒÉn l√†nh m·∫°nh.", imageUrl: "image/noi_chien.jpg" },
            { id: 105, name: "ƒê√®n th√¥ng minh (B·ªô 3)", brand: "Hue", category: "lighting", price: 150, price_range: "low", features: ["RGB", "App control", "Ra l·ªánh gi·ªçng n√≥i"], description: "B·ªô 3 b√≥ng ƒë√®n ƒë·ªïi m√†u, ƒëi·ªÅu khi·ªÉn qua app.", imageUrl: "image/den_thong_minh.jpg" },
            { id: 106, name: "·ªî c·∫Øm th√¥ng minh", brand: "Xiaomi", category: "utility", price: 25, price_range: "low", features: ["H·∫πn gi·ªù", "App control"], description: "Bi·∫øn thi·∫øt b·ªã th∆∞·ªùng th√†nh th√¥ng minh.", imageUrl: "image/o_cam.jpg" },
            { id: 107, name: "Loa th√¥ng minh Echo Dot", brand: "Amazon", category: "entertainment", price: 50, price_range: "low", features: ["Alexa", "Ra l·ªánh gi·ªçng n√≥i", "Nghe nh·∫°c"], description: "Loa tr·ª£ l√Ω ·∫£o Alexa, ƒëi·ªÅu khi·ªÉn nh√†.", imageUrl: "image/loa_echo.jpg" },
            { id: 108, name: "Camera an ninh AI", brand: "Google", category: "security", price: 200, price_range: "medium", features: ["AI", "Ph√°t hi·ªán ng∆∞·ªùi", "Cloud"], description: "Camera an ninh v·ªõi AI ph√°t hi·ªán ng∆∞·ªùi l·∫°.", imageUrl: "image/camera_ai.jpg" },
            { id: 109, name: "Robot h√∫t b·ª•i Eufy Omni E28", brand: "iRobot", category: "utility", price: 1200, price_range: "medium", features: ["AI", "T·ª± s·∫°c", "Lau nh√†"], description: "Robot t·ª± ƒë·ªông l·∫≠p b·∫£n ƒë·ªì nh√† v√† lau d·ªçn, t·ª± v·ªá sinh.", imageUrl: "image/robot2.jpg" },
        ];

        // ƒê·ªãnh nghƒ©a c√°c danh m·ª•c (t·ª´ d·ªØ li·ªáu s·∫£n ph·∫©m)
        const categories = [...new Set(products.map(p => p.category))]; // L·∫•y danh s√°ch duy nh·∫•t
        const categoryDisplayNames = {
            'entertainment': 'Gi·∫£i tr√≠',
            'kitchen': 'N·ªôi tr·ª£',
            'utility': 'Ti·ªán √≠ch',
            'lighting': 'Chi·∫øu s√°ng',
            'security': 'An ninh'
        };

        // --- 2. MODEL LAYER (M√¥ h√¨nh g·ª£i √Ω) ---
        
        // M·ªöI: Bi·∫øn to√†n c·ª•c l∆∞u tr·ªØ ng∆∞·ªùi d√πng ƒëang ch·ªçn
        let selectedUser = users[0];
        
        // M·ªöI: Bi·∫øn l∆∞u tr·ªØ "s·ªü th√≠ch" m√¥ ph·ªèng t·ª´ vi·ªác b·∫•m like
        let simulatedUserInterests = {}; // { 1: { 'kitchen': 1, 'entertainment': 1 } } (userId: { categoryName: score })

        // M·ªöI: Bi·∫øn l∆∞u tr·ªØ c√°c S·∫¢N PH·∫®M C·ª§ TH·ªÇ b·ªã "ch·∫∑n"
        let bannedProducts = {}; // { 1: { 104: true } } (userId: { productId: true })

        /**
         * C·∫¨P NH·∫¨T: H√†m t√≠nh ƒëi·ªÉm ph√π h·ª£p
         * Gi·ªù ƒë√¢y tr·∫£ v·ªÅ { score, reasons } ƒë·ªÉ d√πng cho (Explainable AI - XAI)
         */
        function calculateMatchScore(user, product) {
            let score = 0;
            let reasons = []; // M·∫£ng l√Ω do

            // 1. Kh·ªõp s·ªü th√≠ch ch√≠nh (ƒëi·ªÉm cao nh·∫•t)
            if (user.interest === product.category) {
                score += 5;
                reasons.push(`Ph√π h·ª£p s·ªü th√≠ch "${categoryDisplayNames[user.interest] || user.interest}" c·ªßa b·∫°n.`);
            } else if (user.interest === "entertainment" && (product.category === "lighting" || product.category === "security")) {
                score += 2; 
                reasons.push("G·ª£i √Ω ch√©o: Ng∆∞·ªùi th√≠ch gi·∫£i tr√≠.");
            } else if (user.interest === "kitchen" && product.category === "utility") {
                score += 1;
                reasons.push("G·ª£i √Ω ch√©o: Ng∆∞·ªùi th√≠ch n·ªôi tr·ª£.");
            }
            
            // 2. Kh·ªõp ng√¢n s√°ch
            if (user.budget === "high") {
                score += 2;
                reasons.push("Ph√π h·ª£p ng√¢n s√°ch cao.");
            } else if (user.budget === "medium") {
                if (product.price_range === "medium" || product.price_range === "low") {
                    score += 3;
                    reasons.push("Ph√π h·ª£p ng√¢n s√°ch v·ª´a.");
                }
            } else if (user.budget === "low") {
                if (product.price_range === "low") {
                    score += 4;
                    reasons.push("R·∫•t ph√π h·ª£p ng√¢n s√°ch ti·∫øt ki·ªám.");
                } else {
                    score -= 2; // Ph·∫°t nh·∫π n·∫øu ƒë·∫Øt
                }
            }

            // 3. Kh·ªõp t√≠nh nƒÉng "AI" (n·∫øu ng∆∞·ªùi d√πng y√™u c√¥ng ngh·ªá)
            if (user.name.includes("Y√™u c√¥ng ngh·ªá") && product.features.includes("AI")) {
                score += 3;
                reasons.push("C√≥ t√≠nh nƒÉng 'AI' b·∫°n quan t√¢m.");
            }

            // === PH·∫¶N THAY ƒê·ªîI CH√çNH ===
            // M·ªöI: 4. √Åp d·ª•ng V√≤ng l·∫∑p ph·∫£n h·ªìi (Feedback Loop) - C·∫¨P NH·∫¨T
            // Gi·ªù ƒë√¢y ch√∫ng ta ki·ªÉm tra S·ªû TH√çCH DANH M·ª§C
            
            const userFeedback = simulatedUserInterests[user.id] || {};
            const productCategory = product.category; // L·∫•y danh m·ª•c c·ªßa s·∫£n ph·∫©m ƒëang t√≠nh ƒëi·ªÉm
            
            if (userFeedback[productCategory] === 1) { // N·∫øu user ƒë√£ "Like" danh m·ª•c n√†y
                score += 10; // TƒÉng ƒëi·ªÉm m·∫°nh
                const categoryName = categoryDisplayNames[productCategory] || productCategory;
                reasons.push(`D·ª±a tr√™n s·ªü th√≠ch m·ªõi c·ªßa b·∫°n v·ªÅ "${categoryName}".`);
            
            } else if (userFeedback[productCategory] === -1) { // N·∫øu user ƒë√£ "Dislike" danh m·ª•c n√†y
                score -= 10; // Gi·∫£m ƒëi·ªÉm m·∫°nh
            }
            // === K·∫æT TH√öC PH·∫¶N THAY ƒê·ªîI ===
            
            return { score, reasons };
        }

        
        /**
         * L·∫•y danh s√°ch s·∫£n ph·∫©m g·ª£i √Ω cho m·ªôt user
         */
        function getRecommendations(userId) {
            const user = users.find(u => u.id === parseInt(userId));
            if (!user) return [];

            // M·ªöI: L·∫•y danh s√°ch s·∫£n ph·∫©m b·ªã ch·∫∑n c·ªßa user n√†y
            const userBannedList = bannedProducts[user.id] || {};

            const recommendations = products.map(product => {
                const { score, reasons } = calculateMatchScore(user, product);
                return { product, score, reasons };
            })
            // L·ªçc ra nh·ªØng s·∫£n ph·∫©m c√≥ ƒëi·ªÉm > 3
            .filter(item => item.score > 3)
            
            // === PH·∫¶N THAY ƒê·ªîI CH√çNH ===
            // L·ªçc b·ªï sung: Lo·∫°i b·ªè b·∫•t k·ª≥ s·∫£n ph·∫©m n√†o ƒë√£ b·ªã ng∆∞·ªùi d√πng "ch·∫∑n"
            .filter(item => !userBannedList[item.product.id])
            // === K·∫æT TH√öC PH·∫¶N THAY ƒê·ªîI ===

            // S·∫Øp x·∫øp theo ƒëi·ªÉm s·ªë gi·∫£m d·∫ßn
            .sort((a, b) => b.score - a.score);

            return recommendations;
        }

        // --- 3. FRONTEND LAYER (Render giao di·ªán) ---

        const userSelect = document.getElementById('user-select');
        const recommendationGrid = document.getElementById('recommendation-grid');
        const allProductsGrid = document.getElementById('all-products-grid');
        const recommendationTitle = document.getElementById('recommendation-title');
        const filterToolbar = document.getElementById('filter-toolbar');
        const chatbotSubtitle = document.getElementById('chatbot-subtitle');

        /**
         * C·∫¨P NH·∫¨T: T·∫°o HTML cho m·ªôt th·∫ª s·∫£n ph·∫©m
         * Th√™m (imageUrl), (reasons - XAI), (feedback buttons)
         */
        function createProductCard(product, score = null, reasons = []) {
            const priceFormatted = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(product.price);
            
            // C·∫¨P NH·∫¨T: D√πng ·∫£nh th·∫≠t ho·∫∑c placeholder
            const imageUrl = product.imageUrl || `https://placehold.co/600x400/e2e8f0/64748b?text=${encodeURIComponent(product.name)}`;

            let scoreBadge = '';
            if (score !== null) {
                scoreBadge = `<span class="absolute top-2 right-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full">ƒêi·ªÉm: ${score}</span>`;
            }

            // T·∫°o ph·∫ßn gi·∫£i th√≠ch (XAI)
            let reasonHtml = '';
            if (reasons.length > 0) {
                reasonHtml = `
                    <div class="mt-3 pt-3 border-t border-gray-100">
                        <p class="text-xs font-semibold text-gray-700 mb-1">G·ª£i √Ω v√¨:</p>
                        <ul class="list-disc list-inside space-y-1">
                            ${reasons.map(r => `<li class="text-xs text-gray-600">${r}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // M·ªöI: T·∫°o n√∫t Feedback
            const feedbackHtml = `
                <div class="mt-4 flex justify-end space-x-2">
                    <button class="feedback-btn dislike-btn" data-product-id="${product.id}" data-feedback="-1" title="Kh√¥ng th√≠ch">üëé</button>
                    <button class="feedback-btn like-btn" data-product-id="${product.id}" data-feedback="1" title="Th√≠ch">üëç</button>
                </div>
            `;

            return `
                <div class="bg-white rounded-xl shadow-md overflow-hidden flex flex-col justify-between transform transition-transform duration-300 hover:scale-[1.02]">
                    <div>
                        <div class="relative">
                            <img class="w-full h-48 object-cover" src="${imageUrl}" alt="${product.name}" onerror="this.src='https://placehold.co/600x400/e2e8f0/64748b?text=Image+Error'">
                            ${scoreBadge}
                        </div>
                        <div class="p-4">
                            <div class="text-sm text-gray-500 font-medium">${product.brand}</div>
                            <h3 class="text-lg font-semibold text-gray-800 truncate">${product.name}</h3>
                            <p class="text-xl font-bold text-blue-600 mt-1">${priceFormatted}</p>
                            <p class="text-sm text-gray-600 mt-2 h-10">${product.description}</p>
                            <div class="mt-4 flex flex-wrap gap-2">
                                ${product.features.map(feature => `
                                    <span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full">${feature}</span>
                                `).join('')}
                            </div>
                            ${reasonHtml}
                        </div>
                    </div>
                    ${feedbackHtml}
                </div>
            `;
        }

        /**
         * C·∫¨P NH·∫¨T: Render t·∫•t c·∫£ s·∫£n ph·∫©m (v·ªõi b·ªô l·ªçc)
         */
        function renderAllProducts(filterCategory = null) {
            allProductsGrid.innerHTML = '';
            
            // L·ªçc s·∫£n ph·∫©m n·∫øu c√≥
            const filteredProducts = filterCategory 
                ? products.filter(p => p.category === filterCategory) 
                : products;

            if (filteredProducts.length === 0) {
                allProductsGrid.innerHTML = '<p class="text-gray-600">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o trong danh m·ª•c n√†y.</p>';
                return;
            }

            filteredProducts.forEach(product => {
                allProductsGrid.innerHTML += createProductCard(product);
            });
        }

        /**
         * Render s·∫£n ph·∫©m g·ª£i √Ω
         */
        function renderRecommendations(userId) {
            const user = users.find(u => u.id === parseInt(userId));
            if (!user) return;
            
            recommendationTitle.textContent = `G·ª£i √Ω cho ${user.name}`;
            recommendationGrid.innerHTML = '';
            
            const recommendations = getRecommendations(userId);

            if (recommendations.length === 0) {
                recommendationGrid.innerHTML = `<p class="text-gray-600 md:col-span-2 lg:col-span-3">Kh√¥ng t√¨m th·∫•y g·ª£i √Ω n√†o ph√π h·ª£p. H√£y th·ª≠ th√≠ch m·ªôt v√†i s·∫£n ph·∫©m b√™n d∆∞·ªõi!</p>`;
                return;
            }

            recommendations.forEach(item => {
                recommendationGrid.innerHTML += createProductCard(item.product, item.score, item.reasons);
            });
        }

        /**
         * Kh·ªüi t·∫°o b·ªô ch·ªçn ng∆∞·ªùi d√πng
         */
        function initUserSelect() {
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                userSelect.appendChild(option);
            });
            // C·∫≠p nh·∫≠t ng∆∞·ªùi d√πng m·∫∑c ƒë·ªãnh
            selectedUser = users[0];
            chatbotSubtitle.textContent = `ƒêang t∆∞ v·∫•n cho: ${selectedUser.name}`;
        }
        
        /**
         * M·ªöI: Kh·ªüi t·∫°o thanh l·ªçc
         */
        function initFilterToolbar() {
            // N√∫t "T·∫•t c·∫£"
            filterToolbar.innerHTML += `<button class="filter-btn active" data-category="all">T·∫•t c·∫£</button>`;
            
            // C√°c n√∫t danh m·ª•c
            categories.forEach(category => {
                const displayName = categoryDisplayNames[category] || category;
                filterToolbar.innerHTML += `<button class="filter-btn" data-category="${category}">${displayName}</button>`;
            });

            // G√°n s·ª± ki·ªán click cho c√°c n√∫t l·ªçc
            filterToolbar.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    // X√≥a class 'active' kh·ªèi t·∫•t c·∫£
                    filterToolbar.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                    // Th√™m class 'active' cho n√∫t ƒë∆∞·ª£c click
                    e.target.classList.add('active');
                    
                    const category = e.target.dataset.category;
                    renderAllProducts(category === 'all' ? null : category);
                }
            });
        }

        /**
         * M·ªöI: X·ª≠ l√Ω s·ª± ki·ªán Feedback (Like/Dislike)
         */
        function handleFeedback(event) {
            const button = event.target.closest('.feedback-btn');
            if (!button) return;

            const productId = parseInt(button.dataset.productId);
            const feedbackScore = parseInt(button.dataset.feedback); // 1 cho like, -1 cho dislike
            const userId = selectedUser.id;

            const product = products.find(p => p.id === productId);
            if (!product) return; 
            const category = product.category;

            // 1. Kh·ªüi t·∫°o c√°c "b·ªô nh·ªõ" n·∫øu ch∆∞a c√≥
            if (!simulatedUserInterests[userId]) simulatedUserInterests[userId] = {};
            if (!bannedProducts[userId]) bannedProducts[userId] = {};

            // 2. X·ª≠ l√Ω "b·ªô nh·ªõ" s·ªü th√≠ch DANH M·ª§C (Category)
            if (simulatedUserInterests[userId][category] === feedbackScore) {
                // N·∫øu b·∫•m l·∫°i n√∫t c≈© -> B·ªè ch·ªçn (toggle off)
                delete simulatedUserInterests[userId][category];
            } else {
                // N·∫øu ch·ªçn m·ªõi ho·∫∑c ƒë·ªïi -> Ghi ƒë√® (toggle on)
                simulatedUserInterests[userId][category] = feedbackScore;
            }

            // === PH·∫¶N THAY ƒê·ªîI CH√çNH ===
            // 3. X·ª≠ l√Ω "b·ªô nh·ªõ" ch·∫∑n S·∫¢N PH·∫®M (Product)
            let actionMessage = '';
            const categoryName = categoryDisplayNames[category] || category;

            if (feedbackScore === -1) { // N·∫øu b·∫•m n√∫t "Kh√¥ng th√≠ch"
                if (bannedProducts[userId][productId]) {
                    // N·∫øu s·∫£n ph·∫©m ƒë√£ b·ªã ch·∫∑n -> B·ªè ch·∫∑n (v√¨ ng∆∞·ªùi d√πng b·∫•m l·∫ßn n·ªØa)
                    delete bannedProducts[userId][productId];
                    actionMessage = `ƒê√£ b·ªè ch·∫∑n s·∫£n ph·∫©m n√†y. AI ƒëang h·ªçc l·∫°i...`;
                } else {
                    // N·∫øu s·∫£n ph·∫©m ch∆∞a b·ªã ch·∫∑n -> Th√™m v√†o danh s√°ch ch·∫∑n
                    bannedProducts[userId][productId] = true;
                    actionMessage = `ƒê√£ ghi nh·∫≠n b·∫°n kh√¥ng th√≠ch danh m·ª•c "${categoryName}" v√† s·∫Ω ·∫©n s·∫£n ph·∫©m n√†y.`;
                }
            } else if (feedbackScore === 1) { // N·∫øu b·∫•m n√∫t "Th√≠ch"
                // N·∫øu "Th√≠ch" m·ªôt s·∫£n ph·∫©m, n√≥ ch·∫Øc ch·∫Øn kh√¥ng n√™n b·ªã ch·∫∑n n·ªØa
                if (bannedProducts[userId][productId]) {
                    delete bannedProducts[userId][productId]; // B·ªè ch·∫∑n
                }
                actionMessage = `ƒê√£ ghi nh·∫≠n b·∫°n th√≠ch danh m·ª•c "${categoryName}". AI ƒëang c·∫≠p nh·∫≠t g·ª£i √Ω...`;
            }
            // === K·∫æT TH√öC PH·∫¶N THAY ƒê·ªîI ===

            // 4. Th√¥ng b√°o (gi·∫£ l·∫≠p)
            alert(actionMessage);

            // 5. Render l·∫°i g·ª£i √Ω ngay l·∫≠p t·ª©c
            renderRecommendations(userId);

            // M·ªöI: 6. L∆∞u l·∫°i tr·∫°ng th√°i "ƒë√£ h·ªçc" v√†o localStorage
            saveRecommendationState();
        }

        // M·ªöI: H√†m l∆∞u l·ªãch s·ª≠ chat v√†o localStorage
        function saveChatHistory() {
            if (!selectedUser) return;
            // L∆∞u chat theo key ri√™ng c·ªßa m·ªói user, v√≠ d·ª•: 'chatHistory_1'
            const key = `chatHistory_${selectedUser.id}`;
            localStorage.setItem(key, JSON.stringify(chatConversation));
        }

        // M·ªöI: H√†m t·∫£i l·ªãch s·ª≠ chat t·ª´ localStorage v√† render ra m√†n h√¨nh
        function loadAndRenderChatHistory(userId) {
            const user = users.find(u => u.id === parseInt(userId));
            if (!user) return;
            
            chatHistoryEl.innerHTML = ''; // X√≥a tin nh·∫Øn c≈© tr√™n UI
            const key = `chatHistory_${userId}`;
            const savedHistory = localStorage.getItem(key);

            if (savedHistory && JSON.parse(savedHistory).length > 0) {
                // N·∫øu c√≥ l·ªãch s·ª≠, t·∫£i v√†o bi·∫øn v√† render
                chatConversation = JSON.parse(savedHistory);
                chatConversation.forEach(message => {
                    // D√πng l·∫°i h√†m c≈© ƒë·ªÉ v·∫Ω: 'user' cho tin nh·∫Øn user, 'ai' cho tin nh·∫Øn 'model'
                    const senderType = (message.role === 'model') ? 'ai' : 'user';
                    addMessageToChat(senderType, message.parts[0].text);
                });
            } else {
                // N·∫øu kh√¥ng c√≥ l·ªãch s·ª≠, b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán m·ªõi
                chatConversation = [];
                addMessageToChat('ai', `Xin ch√†o ${user.name}! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay?`);
            }
        }

        // M·ªöI: H√†m l∆∞u tr·∫°ng th√°i "h·ªçc" (s·ªü th√≠ch v√† s·∫£n ph·∫©m ch·∫∑n)
        function saveRecommendationState() {
            localStorage.setItem('reco_interests', JSON.stringify(simulatedUserInterests));
            localStorage.setItem('reco_banned', JSON.stringify(bannedProducts));
        }

        // M·ªöI: H√†m t·∫£i tr·∫°ng th√°i "h·ªçc" t·ª´ localStorage
        function loadRecommendationState() {
            const savedInterests = localStorage.getItem('reco_interests');
            const savedBanned = localStorage.getItem('reco_banned');

            if (savedInterests) {
                simulatedUserInterests = JSON.parse(savedInterests);
            } else {
                simulatedUserInterests = {}; // Kh·ªüi t·∫°o r·ªóng n·∫øu kh√¥ng c√≥
            }

            if (savedBanned) {
                bannedProducts = JSON.parse(savedBanned);
            } else {
                bannedProducts = {}; // Kh·ªüi t·∫°o r·ªóng n·∫øu kh√¥ng c√≥
            }
        }

        // --- 4. CHATBOT LAYER (Gemini API) ---

        const chatHistoryEl = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');

        let chatConversation = []; // S·∫Ω l∆∞u tr·ªØ l·ªãch s·ª≠
        let isLoading = false;

        // C·∫¨P NH·∫¨T: System Prompt c∆° b·∫£n (kh√¥ng c√≤n danh s√°ch user)
        const baseSystemPrompt = `B·∫°n l√† m·ªôt tr·ª£ l√Ω ·∫£o t∆∞ v·∫•n b√°n h√†ng t·∫°i m·ªôt c·ª≠a h√†ng thi·∫øt b·ªã gia d·ª•ng th√¥ng minh. 
        Nhi·ªám v·ª• c·ªßa b·∫°n l√† th√¢n thi·ªán, hi·ªÉu r√µ s·∫£n ph·∫©m v√† gi√∫p kh√°ch h√†ng t√¨m ƒë∆∞·ª£c s·∫£n ph·∫©m ∆∞ng √Ω.
        
        ƒê√¢y l√† danh s√°ch c√°c s·∫£n ph·∫©m (d∆∞·ªõi d·∫°ng JSON) m√† b·∫°n c√≥ trong kho. Ch·ªâ t∆∞ v·∫•n d·ª±a tr√™n c√°c s·∫£n ph·∫©m n√†y:
        ${JSON.stringify(products)}

        QUY T·∫ÆC:
        1. Lu√¥n th√¢n thi·ªán v√† chuy√™n nghi·ªáp.
        2. Khi ng∆∞·ªùi d√πng h·ªèi chung chung (v√≠ d·ª•: "t√¥i n√™n mua g√¨?"), h√£y h·ªèi th√™m v·ªÅ nhu c·∫ßu, ng√¢n s√°ch, ho·∫∑c s·ªü th√≠ch c·ªßa h·ªç (v√≠ d·ª•: "B·∫°n quan t√¢m ƒë·∫øn thi·∫øt b·ªã gi·∫£i tr√≠, nh√† b·∫øp hay ti·ªán √≠ch?").
        3. Khi ng∆∞·ªùi d√πng cung c·∫•p ƒë·ªß th√¥ng tin, h√£y g·ª£i √Ω m·ªôt ho·∫∑c nhi·ªÅu s·∫£n ph·∫©m C·ª§ TH·ªÇ t·ª´ danh s√°ch tr√™n.
        4. Tr·∫£ l·ªùi ng·∫Øn g·ªçn, t·∫≠p trung v√†o c√°c t√≠nh nƒÉng ch√≠nh v√† l·ª£i √≠ch.
        5. N·∫øu kh√¥ng bi·∫øt, h√£y n√≥i th·∫≠t, ƒë·ª´ng b·ªãa th√¥ng tin.
        6. QUY T·∫ÆC QUAN TR·ªåNG NH·∫§T: TUY·ªÜT ƒê·ªêI KH√îNG S·ª¨ D·ª§NG Markdown d∆∞·ªõi m·ªçi h√¨nh th·ª©c (v√≠ d·ª•: kh√¥ng d√πng **d·∫•u sao** ƒë·ªÉ in ƒë·∫≠m, kh√¥ng d√πng g·∫°ch ƒë·∫ßu d√≤ng *). Ch·ªâ s·ª≠ d·ª•ng vƒÉn b·∫£n thu·∫ßn t√∫y (plain text) ƒë·ªÉ tr·∫£ l·ªùi.`;

        /**
         * Th√™m tin nh·∫Øn v√†o giao di·ªán chat
         */
        function addMessageToChat(sender, message) {
            let bubble;
            if (sender === 'user') {
                bubble = `...`; // (Gi·ªØ nguy√™n nh∆∞ code c≈©)
            } else { // 'ai'
                bubble = `...`; // (Gi·ªØ nguy√™n nh∆∞ code c≈©)
            }
            // (Copy code t·ª´ file c≈© c·ªßa b·∫°n v√†o ƒë√¢y)
        }
        
        // (Copy h√†m addMessageToChat, showLoading t·ª´ file c≈© c·ªßa b·∫°n v√†o ƒë√¢y)
        // ...
        // START: Copy h√†m addMessageToChat
        function addMessageToChat(sender, message) {
            let bubble;
            if (sender === 'user') {
                bubble = `
                    <div class="flex justify-end">
                        <div class="bg-gray-200 text-gray-800 p-3 rounded-lg max-w-xs">
                            <p>${message}</p>
                        </div>
                        <span class="flex-shrink-0 bg-gray-500 text-white text-sm font-semibold rounded-full h-8 w-8 items-center justify-center flex ml-3">User</span>
                    </div>
                `;
            } else { // 'ai'
                bubble = `
                    <div class="flex">
                        <span class="flex-shrink-0 bg-blue-500 text-white text-sm font-semibold rounded-full h-8 w-8 items-center justify-center flex mr-3">AI</span>
                        <div class="bg-blue-100 text-gray-800 p-3 rounded-lg max-w-xs">
                            <p>${message}</p>
                        </div>
                    </div>
                `;
            }
            chatHistoryEl.innerHTML += bubble;
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        }
        // END: Copy h√†m addMessageToChat
        
        // START: Copy h√†m showLoading
        function showLoading(show) {
            let loadingEl = document.getElementById('loading-indicator');
            if (show) {
                if (!loadingEl) {
                    loadingEl = document.createElement('div');
                    loadingEl.id = 'loading-indicator';
                    loadingEl.classList.add('flex');
                    loadingEl.innerHTML = `
                        <span class="flex-shrink-0 bg-blue-500 text-white text-sm font-semibold rounded-full h-8 w-8 items-center justify-center flex mr-3">AI</span>
                        <div class="bg-blue-100 text-gray-800 p-3 rounded-lg">
                            <div class="loader"></div>
                        </div>
                    `;
                    chatHistoryEl.appendChild(loadingEl);
                    chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
                }
            } else {
                if (loadingEl) {
                    loadingEl.remove();
                }
            }
        }
        // END: Copy h√†m showLoading


        /**
         * C·∫¨P NH·∫¨T: X·ª≠ l√Ω khi ng∆∞·ªùi d√πng g·ª≠i tin nh·∫Øn
         * Gi·ªù ƒë√¢y s·∫Ω g·ª≠i k√®m "b·ªëi c·∫£nh" ng∆∞·ªùi d√πng cho API
         */
        async function handleChatSend() {
            const message = chatInput.value.trim();
            if (message === '' || isLoading) return;

            isLoading = true;
            chatInput.value = '';
            addMessageToChat('user', message);
            showLoading(true);

            // Th√™m tin nh·∫Øn m·ªõi v√†o l·ªãch s·ª≠
            chatConversation.push({ role: "user", parts: [{ text: message }] });
            saveChatHistory();

            // API Gemini
            const apiKey = "AIzaSyAPkNy5C0nUkxiEn9EEG2UfVCnvXQqkXMQ"; // API key (gi·ªØ nguy√™n)
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // M·ªöI: T·∫°o b·ªëi c·∫£nh ƒë·ªông cho chatbot
            const userContextPrompt = `
                ---
                B·ªêI C·∫¢NH NG∆Ø·ªúI D√ôNG HI·ªÜN T·∫†I (R·∫•t quan tr·ªçng):
                B·∫°n ƒëang t∆∞ v·∫•n cho: ${selectedUser.name}.
                - Tu·ªïi: ${selectedUser.age}
                - Ng√¢n s√°ch: ${selectedUser.budget}
                - S·ªü th√≠ch ch√≠nh: ${selectedUser.interest}
                H√£y c√° nh√¢n h√≥a l·ªùi ch√†o v√† t∆∞ v·∫•n c·ªßa b·∫°n d·ª±a tr√™n th√¥ng tin n√†y! V√≠ d·ª•: ch√†o "An", v√† t·∫≠p trung v√†o s·ªü th√≠ch "entertainment" c·ªßa An.
                ---
            `;
            
            // K·∫øt h·ª£p prompt c∆° b·∫£n v√† b·ªëi c·∫£nh ƒë·ªông
            const finalSystemPrompt = baseSystemPrompt + userContextPrompt;

            const payload = {
                systemInstruction: {
                    parts: [{ text: finalSystemPrompt }]
                },
                contents: chatConversation // G·ª≠i to√†n b·ªô l·ªãch s·ª≠
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const aiMessage = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiMessage) {
                    addMessageToChat('ai', aiMessage);
                    chatConversation.push({ role: "model", parts: [{ text: aiMessage }] });
                    saveChatHistory();
                } else {
                    addMessageToChat('ai', "R·∫•t ti·∫øc, t√¥i g·∫∑p l·ªói khi x·ª≠ l√Ω y√™u c·∫ßu c·ªßa b·∫°n. (Kh√¥ng c√≥ ph·∫£n h·ªìi)");
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                addMessageToChat('ai', "R·∫•t ti·∫øc, t√¥i ƒëang g·∫∑p s·ª± c·ªë k·ªπ thu·∫≠t. B·∫°n vui l√≤ng th·ª≠ l·∫°i sau.");
            } finally {
                isLoading = false;
                showLoading(false);
            }
        }
        
        // (Copy h√†m fetchWithBackoff t·ª´ file c≈© c·ªßa b·∫°n v√†o ƒë√¢y)
        // ...
        // START: Copy h√†m fetchWithBackoff
        async function fetchWithBackoff(url, options, maxRetries = 5, baseDelay = 1000) {
            let delay = baseDelay;
            for (let i = 0; i < maxRetries; i++) {
                const response = await fetch(url, options);
                if (response.status !== 429) {
                    return response;
                }
                const jitter = Math.random() * delay * 0.5;
                await new Promise(resolve => setTimeout(resolve, delay + jitter));
                delay *= 2;
            }
            throw new Error("API throttling (429) - Max retries exceeded.");
        }
        // END: Copy h√†m fetchWithBackoff


        // --- 5. INITIALIZATION (Kh·ªüi ch·∫°y) ---

        document.addEventListener('DOMContentLoaded', () => {
            // Kh·ªüi t·∫°o
            initUserSelect();
            initFilterToolbar(); // M·ªöI
            renderAllProducts(); // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã t·∫•t c·∫£
            
            // M·ªöI: T·∫£i tr·∫°ng th√°i "ƒë√£ h·ªçc" t·ª´ l·∫ßn tr∆∞·ªõc
            loadRecommendationState();
            
            // Render g·ª£i √Ω cho ng∆∞·ªùi d√πng ƒë·∫ßu ti√™n
            if (users.length > 0) {
                renderRecommendations(users[0].id)
                loadAndRenderChatHistory(users[0].id);
            }

            userSelect.addEventListener('change', (e) => {
                const newUserId = parseInt(e.target.value);
                selectedUser = users.find(u => u.id === newUserId);
                chatbotSubtitle.textContent = `ƒêang t∆∞ v·∫•n cho: ${selectedUser.name}`;
                renderRecommendations(newUserId);
                
                // M·ªöI: T·∫£i l·ªãch s·ª≠ chat c·ªßa user m·ªõi, thay v√¨ reset
                loadAndRenderChatHistory(newUserId);
            });

            sendButton.addEventListener('click', handleChatSend);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleChatSend();
                }
            });
            
            // M·ªöI: G√°n s·ª± ki·ªán chung cho Feedback
            document.body.addEventListener('click', handleFeedback);
        });

    </script>
</body>
</html>
